<html>
  <head>
    <meta content='通过API更新Google账户通讯录 - Peaceful Revolution' property='og:title' />
    <title>通过API更新Google账户通讯录 - Peaceful Revolution</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css' />
<link href='/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/syntax.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/responsive.css' rel='stylesheet' type='text/css' />
<!-- - -->
<script src='/javascripts/jquery.js' type='text/javascript'></script>
<script src='/javascripts/pd.js' type='text/javascript'></script>
<script src='/javascripts/basics.js' type='text/javascript'></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<!-- - -->
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />
<meta content="http://muan.co/images/og.png" property="og:image" />
<meta content="" property="fb:app_id" />

  <meta content='http://www.wiserfirst.com/2011/09/05/update-google-contacts-via-api/' property='og:url' />
  <meta content="之前用的手机是Nokia，为了保存上面的通讯录，我按照这里的方法使用Google Sync将其同步到Google帐户。然后就可以在Gmail的通讯录当中访问了。换了iPhone之后自然要把通讯录从Google帐户同步过来。步骤如下：1..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=604714799556697";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  </head>
  <body>
    <header>
<a id="go-back-home" href="/"><img src="/images/scribble.png" alt="scribble" width="53" height="59"></a>
<p>Peaceful Revolution</p>
</header>
    <div id='container'>
      <div class="block">
  
    <a target="_top" class="main" href="/">Home</a>
  
    <a target="_top" class="main" href="/about">About</a>
  
    <a target="_blank" class="main" href="https://www.linkedin.com/pub/qing-wu/30/634/8a4">LinkedIn</a>
  
    <a target="_blank" class="main" href="mailto:wiserfirst@gmail.com">Email</a>
  
    <a target="_blank" class="main" href="https://github.com/wiserfirst">GitHub</a>
  
</div>
      <section class="paging">
  
    <div class="left">
      <a href="/thinking/2011/03/18/%25e6%2596%2587%25e8%2589%25ba%25e9%259d%2592%25e5%25b9%25b4%25e6%2594%25b9%25e5%258f%2598%25e4%25b8%2596%25e7%2595%258c/">
        ‹
      </a>
    </div>
  
  
    <div class="right">
      <a href="/2013/02/02/update-multiple-text-files-in-terminal-with-regex/">
        ›
      </a>
    </div>
  
</section>
      <div class="content">
        <section class='post'>
          <h1 class="upcase">
            <div class='date'>05 Sep 2011</div>
            通过API更新Google账户通讯录
          </h1>
          <div>之前用的手机是Nokia，为了保存上面的通讯录，我按照<a href="http://www.allaboutsymbian.com/news/item/8922_Google_Sync_Beta_for_SyncML_S6.php">这里</a>的方法使用Google Sync将其同步到Google帐户。然后就可以在Gmail的通讯录当中访问了。换了iPhone之后自然要把通讯录从Google帐户同步过来。</div>

<div>步骤如下：</div>
<div>1 在设置--&gt;邮件、通讯录、日历 中选择添加帐户</div>
<div>2 Microsoft Exchange</div>
<div>3 填入你的Google帐户，如下图（唯一需要注意的就是服务器填 m.google.com）<img class="aligncenter" src="assets/IMG_0091.png" alt="" /></div>
<div>4 接着在该帐户的设置中，要确认邮件、通讯录和日历这三项的同步是否要打开，这个根据自己需要处理吧。当然了，要同步通讯录的话，通讯录这项一定要打开才行。</div>
<div>5 邮件、通讯录、日历--&gt;获取新数据 中打开推送（最好在有WIFI接入点时）</div>
<div>这样设置完成以后，稍等一小会，再打开iPhone通讯录时，就会发现Gmail通讯录里的联系人了。</div>
<div>到这里似乎就大功告成了，然而实际情况往往并不如意。比如我这里就出了个小问题：部分联系人一切正常；但是另一部分联系人里面没有电话号码，只是个空的联系人……经过对比iPhone通讯录和Gmail通讯录，我发现一个规律，即Gmail中的号码类型标签为"Other"的电话号码，iPhone上统统没有。</div>
<div>第一反应是问Google，但是一番搜索并没有发现解决方案——似乎没有人碰到这个问题……</div>
<div>那只能尝试着自己动手了。简单分析一下这个问题，应该是把号码标签类型从"Other"改成"Mobile"或者"Home"。登录到Gmail上手动改当然是可以了，不过偶的通讯录有200多条，一个个改太麻烦了。作为程序员，应该尝试自己写代码解决问题，Google应该有提供修改联系人的API。查一下果然有，就是这个<a href="http://code.google.com/intl/zh-CN/apis/contacts/docs/3.0/developers_guide.html">Google Contacts Data API</a>。Google提供Java、.NET及python等多种语言接口，由于正在自学python，就用它吧。到<a href="http://code.google.com/p/gdata-python-client/downloads/list">这里</a>下载<a href="http://code.google.com/p/gdata-python-client/">Python Client Library</a>。然后开始研究电话号码及其标签是使用什么数据结构保存的。结果如下：</div>
<div>通讯录条目为class 'gdata.contacts.data.ContactEntry'；</div>
<div>其中的电话号码字段名为"phone_number"，它是一个list，每个电话号码为list中一项，类型是class 'gdata.data.PhoneNumber'；</div>
<div>PhoneNumber类型的rel字段是一个类似于'<a href="http://schemas.google.com/g/2005#other">http://schemas.google.com/g/2005#other</a>'的字符串，保存了号码标签；而是其text字段是真正的电话号码，如"13526541245"，但其类型还不是string，需要对其调用str()才能得到字符串。</div>
<div>另外，经验证还发现：在Gmail的通讯录中，号码标签共有9种类型，以下六种可以正确同步到iOS设备的通讯录中，</div>
<div>
<table width="50%" border="1" cellspacing="0" cellpadding="2">
<tbody>
<tr>
<td valign="top">Gmail</td>
<td valign="top">iOS</td>
</tr>
<tr>
<td valign="top">Mobile</td>
<td valign="top">移动电话</td>
</tr>
<tr>
<td valign="top">Work</td>
<td valign="top">工作</td>
</tr>
<tr>
<td valign="top">
<div>Work Fax</div>
</td>
<td valign="top">
<div>工作传真</div>
</td>
</tr>
<tr>
<td valign="top">
<div>Home</div>
</td>
<td valign="top">住宅</td>
</tr>
<tr>
<td valign="top">
<div>Home Fax</div>
</td>
<td valign="top">
<div>住宅传真</div>
</td>
</tr>
<tr>
<td valign="top">Pager</td>
<td valign="top">传呼</td>
</tr>
</tbody>
</table>
<p>另外3种类型（Google Voice, Main, Custom）不能同步到iOS设备的通讯录。注意这个Custom是用户自定义，可以输入任何字符串（一定长度以内），在Gmail通讯录都可以正确保存。使用Gsync同步Nokia手机通讯录到Gmail的时候，有些手机号的标签会是"Other"，也就是一种自定义类型。就是这个导致从Nokia手机同步过来的通讯录中有些联系人名字在但是号码却是空的。</p></div>
<div>然后就开始写代码，逻辑无非就是：</div>
<div>if 号码标签为Other :</div>
<div>    if 手机号:</div>
<div>        将号码标签改为Mobile</div>
<div>    else:</div>
<div>        将号码标签改为Work</div>
<div>真正实现这个逻辑并没有花多少时间，在Google提供的sample代码里面很容易就改出来了；倒是找表示电话号码的字段名，以及表示号码标签的字段名，花了一些时间。因为Google所提供的库中，类的定义实在是有点复杂——至少对我这个没接触过的新手而言是这样。全部理清头绪以后，回过头想想其实整个过程并不困难，如果对Google的库有些熟悉，应该很快就能搞定的。</div>



        </section>
      </div>
      

      
      <div class="block">
  
    <a target="_top" class="main" href="/">Home</a>
  
    <a target="_top" class="main" href="/about">About</a>
  
    <a target="_blank" class="main" href="https://www.linkedin.com/pub/qing-wu/30/634/8a4">LinkedIn</a>
  
    <a target="_blank" class="main" href="mailto:wiserfirst@gmail.com">Email</a>
  
    <a target="_blank" class="main" href="https://github.com/wiserfirst">GitHub</a>
  
</div>
    </div>
    <footer>
  <span class="muted">built with <a href="https://github.com/jekyll/jekyll">Jekyll</a> using <a href="https://github.com/muan/scribble">Scribble theme</a></span>
  <br />
  <br />
  <img src="/images/scribble2.png" alt="scribble" /> 
</footer>

  </body>
</html>
